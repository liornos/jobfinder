name: Smoke

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Check search page
        run: |
          set -euo pipefail
          url="https://jobfinder-8def.onrender.com/search"
          for i in 1 2 3 4 5; do
            echo "Attempt $i..."
            if curl -fsSL --max-time 20 "$url" | grep -q "JobFinder Quick Search"; then
              echo "Smoke OK"
              exit 0
            fi
            sleep 5
          done
          echo "Smoke test failed"
          exit 1
      - name: Install Playwright (Chromium)
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest playwright
          python -m playwright install --with-deps chromium
      - name: Search Tel Aviv smoke
        env:
          RUN_PROD_SMOKE: "1"
          JOBFINDER_SMOKE_URL: "https://jobfinder-8def.onrender.com"
          JOBFINDER_SMOKE_CITY: "Tel Aviv"
        run: pytest tests/smoke/test_prod_search_smoke.py -q
