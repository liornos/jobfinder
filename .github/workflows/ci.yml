name: CI

on:
  pull_request:
  push:
    branches: ["master"]

permissions:
  contents: read
  checks: write

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - name: Install
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev,e2e]"
      - name: Install Playwright (Chromium)
        run: python -m playwright install --with-deps chromium
      - name: Lint
        run: ruff check .
      - name: Format check
        run: ruff format --check .
      - name: Type check
        run: mypy jobfinder tests
      - name: Prepare test reports
        run: mkdir -p reports
      - name: Unit tests
        run: pytest tests/unit tests/test_filtering.py --cov=jobfinder --cov-report=term --junitxml=reports/junit-unit.xml
      - name: Integration tests
        run: pytest tests/integration tests/test_pipeline.py tests/test_api_e2e.py --cov=jobfinder --cov-report=term --cov-append --junitxml=reports/junit-integration.xml
      - name: E2E UI tests (headless)
        run: pytest tests/e2e/test_ui_e2e.py -q --junitxml=reports/junit-e2e.xml
      - name: Coverage
        run: python -m coverage report --show-missing --skip-empty
      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Tests
          path: reports/junit-*.xml
          reporter: java-junit
          fail-on-error: true
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-reports
          path: |
            reports/*.xml
            test-results/**
            playwright-report/**
          if-no-files-found: ignore
      - name: Test summary
        if: always()
        run: |
          python - <<'PY'
          import glob
          import os
          from pathlib import Path
          import xml.etree.ElementTree as ET

          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")
          files = sorted(glob.glob("reports/junit-*.xml"))
          if not files:
              text = "## Test Summary\n\nNo JUnit XML files found.\n"
              if summary_path:
                  Path(summary_path).write_text(text, encoding="utf-8")
              else:
                  print(text)
              raise SystemExit(0)

          totals = {"tests": 0, "failures": 0, "errors": 0, "skipped": 0}

          def add_suite(elem):
              totals["tests"] += int(elem.attrib.get("tests", 0))
              totals["failures"] += int(elem.attrib.get("failures", 0))
              totals["errors"] += int(elem.attrib.get("errors", 0))
              totals["skipped"] += int(elem.attrib.get("skipped", 0))

          for filename in files:
              try:
                  root = ET.parse(filename).getroot()
              except Exception:
                  continue
              if root.tag == "testsuite":
                  add_suite(root)
              else:
                  for suite in root.findall("testsuite"):
                      add_suite(suite)

          passed = (
              totals["tests"]
              - totals["failures"]
              - totals["errors"]
              - totals["skipped"]
          )

          lines = [
              "## Test Summary",
              "",
              "| Metric | Count |",
              "| --- | ---: |",
              f"| Tests | {totals['tests']} |",
              f"| Passed | {passed} |",
              f"| Failures | {totals['failures']} |",
              f"| Errors | {totals['errors']} |",
              f"| Skipped | {totals['skipped']} |",
              "",
              "Reports:",
              "",
              *[f"- `{name}`" for name in files],
              "",
              "See the **Tests** check run for details.",
          ]

          content = "\n".join(lines) + "\n"
          if summary_path:
              Path(summary_path).write_text(content, encoding="utf-8")
          else:
              print(content)
          PY
